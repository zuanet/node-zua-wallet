"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Storage = void 0;
const logger_1 = require("../utils/logger");
const helper_1 = require("../utils/helper");
const IS_NODE = typeof process === 'object'
    && typeof process.versions === 'object'
    && typeof process.versions.node === 'string';
class DBInterface {
}
const classes = {};
class LSDB extends DBInterface {
    constructor(opt = {}) {
        super();
        this.LS = window.localStorage;
    }
    backup() {
        let data = this.getWallet();
        if (!data)
            return;
        let ts = Date.now();
        this.LS.setItem("zua-wallet-" + ts, data);
        let cache = this.getCache();
        if (cache)
            this.LS.setItem("zua-cache-" + ts, cache);
    }
    saveWallet(data) {
        this.LS.setItem("zua-wallet", data);
    }
    getWallet() {
        return this.LS.getItem("zua-wallet");
    }
    saveCache(cache) {
        return this.LS.setItem("zua-cache", cache);
    }
    getCache() {
        return this.LS.getItem("zua-cache");
    }
}
classes.LSDB = LSDB;
if (IS_NODE) {
    const path = require("path");
    const os = require("os");
    const fs = require("fs");
    class FileDB extends DBInterface {
        constructor(opt = {}) {
            super();
            let { fileName = "zua", folder } = opt;
            this.fileName = fileName;
            this.folder = folder || this.getHomeFolder();
            if (!fs.existsSync(this.folder))
                fs.mkdirSync(this.folder, { recursive: true });
            this.walletFile = this.createFilePath('kpk');
            this.txFile = this.createFilePath('ktx');
            this.cacheFile = this.createFilePath('cache');
        }
        createFilePath(ext = 'kpk', suffix = '') {
            return path.join(this.folder, `${this.fileName}${suffix}.${ext}`);
        }
        getHomeFolder() {
            let { APPDATA, HOME } = process.env;
            if (!HOME)
                HOME = os.homedir();
            if (APPDATA) // windows
                return path.join(APPDATA, 'Zua');
            if (process.platform == 'darwin')
                return path.join(HOME, '/Library/Application Support/Zua/');
            return path.join(HOME, '.zua');
        }
        backup() {
            let bk = '-backup-' + helper_1.UID("-");
            if (fs.existsSync(this.walletFile)) {
                let newPath = this.createFilePath('kpk', bk);
                fs.renameSync(this.walletFile, newPath);
            }
            if (fs.existsSync(this.txFile)) {
                let newPath = this.createFilePath('ktx', bk);
                fs.renameSync(this.txFile, newPath);
            }
            if (fs.existsSync(this.cacheFile)) {
                let newPath = this.createFilePath('cache', bk);
                fs.renameSync(this.cacheFile, newPath);
            }
        }
        saveWallet(data) {
            fs.writeFileSync(this.walletFile, data);
        }
        getWallet() {
            if (fs.existsSync(this.walletFile))
                return fs.readFileSync(this.walletFile) + "";
            return false;
        }
        saveCache(cache) {
            return fs.writeFileSync(this.cacheFile, cache);
        }
        getCache() {
            if (fs.existsSync(this.cacheFile))
                return fs.readFileSync(this.cacheFile) + "";
            return undefined;
        }
    }
    classes.FileDB = FileDB;
}
class Storage {
    constructor(opt = {}) {
        this.logger = logger_1.CreateLogger("ZuaStorage");
        const { fileDbOptions = {} } = opt;
        if (opt.logLevel)
            this.setLogLevel(opt.logLevel);
        if (IS_NODE) {
            this.db = new classes.FileDB(fileDbOptions);
        }
        else {
            this.db = new classes.LSDB();
        }
    }
    /*
    * @return {String|Buffer} wallet
    */
    getWallet() {
        let content = this.db.getWallet();
        if (!content)
            return false;
        try {
            return JSON.parse(content);
        }
        catch (e) {
            return false;
        }
    }
    _buildWalletContent(mnemonic, meta = {}) {
        return Object.assign({
            type: "zua-wallet",
            encryption: "default",
            version: 1,
            generator: "cli",
            wallet: {
                mnemonic
            }
        }, meta || {});
    }
    createWallet(mnemonic, meta = {}) {
        //this.logger.debug("createWallet:", wallet)
        this.db.backup();
        this.db.saveCache('');
        return this.saveWallet(mnemonic, meta);
    }
    saveWallet(mnemonic, meta = {}) {
        //this.logger.debug("saveWallet:", wallet)
        let wallet = this._buildWalletContent(mnemonic, meta);
        let json = JSON.stringify(wallet);
        return this.db.saveWallet(json);
    }
    /*
    * @return {WalletCache|undefined} cache
    */
    getCache() {
        let cache = this.db.getCache();
        if (!cache)
            return false;
        try {
            return JSON.parse(cache);
        }
        catch (e) {
            return false;
        }
    }
    saveCache(cache) {
        let data = JSON.stringify(cache);
        this.db.saveCache(data);
    }
    setLogLevel(level) {
        this.logger.setLevel(level);
    }
    addTransaction(tx) {
    }
}
exports.Storage = Storage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3dhbGxldC9zdG9yYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRDQUFxRDtBQUNyRCw0Q0FBb0M7QUFJcEMsTUFBTSxPQUFPLEdBQUcsT0FBTyxPQUFPLEtBQUssUUFBUTtPQUN2QyxPQUFPLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUTtPQUNwQyxPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQztBQXNDOUMsTUFBZSxXQUFXO0NBTXpCO0FBT0QsTUFBTSxPQUFPLEdBQWdDLEVBQUUsQ0FBQztBQUVoRCxNQUFNLElBQUssU0FBUSxXQUFXO0lBRTdCLFlBQVksTUFBYyxFQUFFO1FBQzNCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO0lBQy9CLENBQUM7SUFFRCxNQUFNO1FBQ0wsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzVCLElBQUcsQ0FBQyxJQUFJO1lBQ1AsT0FBTTtRQUNQLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEdBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzFDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM1QixJQUFHLEtBQUs7WUFDUCxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEdBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFDRCxVQUFVLENBQUMsSUFBVztRQUNyQixJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELFNBQVM7UUFDUixPQUFP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LENBQUM7Q0FDRDtBQXBGRCwwQkFvRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NyZWF0ZUxvZ2dlciwgTG9nZ2VyfSBmcm9tICcuLi91dGlscy9sb2dnZXInO1xyXG5pbXBvcnQge1VJRH0gZnJvbSAnLi4vdXRpbHMvaGVscGVyJztcclxuaW1wb3J0IHsgV2FsbGV0Q2FjaGUgfSBmcm9tICcuLi90eXBlcy9jdXN0b20tdHlwZXMnO1xyXG5cclxuZXhwb3J0IHR5cGUgU3RvcmFnZVR5cGUgPSAnRklMRSd8J0xTJztcclxuY29uc3QgSVNfTk9ERSA9IHR5cGVvZiBwcm9jZXNzID09PSAnb2JqZWN0JyBcclxuXHQmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucyA9PT0gJ29iamVjdCdcclxuXHQmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucy5ub2RlID09PSAnc3RyaW5nJztcclxuXHJcbmV4cG9ydCB0eXBlIFN0b3JhZ2VPcHRzID0ge1xyXG5cdGxvZ0xldmVsPzpzdHJpbmcsXHJcblx0cGFzc3dvcmQ/OnN0cmluZyxcclxuXHRmaWxlRGJPcHRpb25zPzp7XHJcblx0XHRmaWxlTmFtZT86c3RyaW5nLFxyXG5cdFx0Zm9sZGVyPzpzdHJpbmdcclxuXHR9XHJcbn07XHJcbmV4cG9ydCBpbnRlcmZhY2UgVFhTdG9yZUl0ZW17XHJcblx0aW46Ym9vbGVhbjtcclxuXHR0czpudW1iZXI7XHJcblx0aWQ6c3RyaW5nO1xyXG5cdGFtb3VudDpudW1iZXI7XHJcblx0YWRkcmVzczpzdHJpbmc7XHJcblx0bm90ZT86c3RyaW5nO1xyXG5cdHR4PzphbnlcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIFdhbGxldE1ldGF7XHJcblx0dmVyc2lvbj86c3RyaW5nO1xyXG5cdGdlbmVyYXRvcj86c3RyaW5nO1xyXG5cdGVuY3J5cHRpb24/OnN0cmluZztcclxuXHR3YWxsZXQ/OnttbmVtb25pYz86c3RyaW5nfVxyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgV2FsbGV0Q29udGVudHtcclxuXHR0eXBlOnN0cmluZztcclxuXHR2ZXJzaW9uOnN0cmluZztcclxuXHRnZW5lcmF0b3I6c3RyaW5nO1xyXG5cdGVuY3J5cHRpb246c3RyaW5nO1xyXG5cdHdhbGxldDp7bW5lbW9uaWM6c3RyaW5nfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgREJPcHRpb25ze1xyXG5cdGZpbGVOYW1lPzpzdHJpbmcsXHJcblx0Zm9sZGVyPzpzdHJpbmdcclxufVxyXG5cclxuYWJzdHJhY3QgY2xhc3MgREJJbnRlcmZhY2V7XHJcblx0YWJzdHJhY3QgYmFja3VwKCk6dm9pZDtcclxuXHRhYnN0cmFjdCBzYXZlV2FsbGV0KGRhdGE6c3RyaW5nKTp2b2lkO1xyXG5cdGFic3RyYWN0IGdldFdhbGxldCgpOnN0cmluZ3xmYWxzZTtcclxuXHRhYnN0cmFjdCBnZXRDYWNoZSgpOnN0cmluZ3x1bmRlZmluZWQ7XHJcblx0YWJzdHJhY3Qgc2F2ZUNhY2hlKGNhY2hlOnN0cmluZyk6dm9pZFxyXG59XHJcblxyXG5pbnRlcmZhY2UgREJDb25zdHJ1Y3RvciB7XHJcbiAgICBuZXcgKG9wdD86REJPcHRpb25zKTogREJJbnRlcmZhY2U7XHJcbn1cclxuXHJcblxyXG5jb25zdCBjbGFzc2VzOntba2V5OnN0cmluZ106REJDb25zdHJ1Y3Rvcn0gPSB7fTtcclxuXHJcbmNsYXNzIExTREIgZXh0ZW5kcyBEQkludGVyZmFjZXtcclxuXHRMUzogYW55O1xyXG5cdGNvbnN0cnVjdG9yKG9wdDpEQk9wdGlvbnM9e30pe1xyXG5cdFx0c3VwZXIoKTtcclxuXHRcdHRoaXMuTFMgPSB3aW5kb3cubG9jYWxTdG9yYWdlO1xyXG5cdH1cclxuXHJcblx0YmFja3VwKCk6dm9pZHtcclxuXHRcdGxldCBkYXRhID0gdGhpcy5nZXRXYWxsZXQoKTtcclxuXHRcdGlmKCFkYXRhKVxyXG5cdFx0XHRyZXR1cm5cclxuXHRcdGxldCB0cyA9IERhdGUubm93KCk7XHJcblx0XHR0aGlzLkxTLnNldEl0ZW0oXCJrYXNwYS13YWxsZXQtXCIrdHMsIGRhdGEpO1xyXG5cdFx0bGV0IGNhY2hlID0gdGhpcy5nZXRDYWNoZSgpO1xyXG5cdFx0aWYoY2FjaGUpXHJcblx0XHRcdHRoaXMuTFMuc2V0SXRlbShcImthc3BhLWNhY2hlLVwiK3RzLCBjYWNoZSk7XHJcblx0fVxyXG5cdHNhdmVXYWxsZXQoZGF0YTpzdHJpbmcpOnZvaWR7XHJcblx0XHR0aGlzLkxTLnNldEl0ZW0oXCJrYXNwYS13YWxsZXRcIiwgZGF0YSk7XHJcblx0fVxyXG5cclxuXHRnZXRXYWxsZXQoKTpzdHJpbmd8ZmFsc2V7XHJcblx0XHRyZXR1cm4gdGhpcy5MUy5nZXRJdGVtKFwia2FzcGEtd2FsbGV0XCIpO1xyXG5cdH1cclxuXHJcblx0c2F2ZUNhY2hlKGNhY2hlOnN0cmluZyl7XHJcblx0XHRyZXR1cm4gdGhpcy5MUy5zZXRJdGVtKFwia2FzcGEtY2FjaGVcIiwgY2FjaGUpO1xyXG5cdH1cclxuXHJcblx0Z2V0Q2FjaGUoKTpzdHJpbmd8dW5kZWZpbmVke1xyXG5cdFx0cmV0dXJuIHRoaXMuTFMuZ2V0SXRlbShcImthc3BhLWNhY2hlXCIpO1xyXG5cdH1cclxufVxyXG5cclxuY2xhc3Nlcy5MU0RCID0gTFNEQjtcclxuXHJcbmlmKElTX05PREUpe1xyXG5cdGNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuXHRjb25zdCBvcyA9IHJlcXVpcmUoXCJvc1wiKTtcclxuXHRjb25zdCBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcclxuXHJcblx0Y2xhc3MgRmlsZURCIGV4dGVuZHMgREJJbnRlcmZhY2V7XHJcblx0XHR3YWxsZXRGaWxlOnN0cmluZztcclxuXHRcdHR4RmlsZTpzdHJpbmc7XHJcblx0XHRmaWxlTmFtZTpzdHJpbmc7XHJcblx0XHRmb2xkZXI6c3RyaW5nO1xyXG5cdFx0Y2FjaGVGaWxlOnN0cmluZztcclxuXHJcblx0XHRjb25zdHJ1Y3RvcihvcHQ6REJPcHRpb25zPXt9KXtcclxuXHRcdFx0c3VwZXIoKTtcclxuXHRcdFx0bGV0IHtmaWxlTmFtZT1cImthc3BhXCIsIGZvbGRlcn0gPSBvcHQ7XHJcblx0XHRcdHRoaXMuZmlsZU5hbWUgPSBmaWxlTmFtZTtcclxuXHRcdFx0dGhpcy5mb2xkZXIgPSBmb2xkZXJ8fHRoaXMuZ2V0SG9tZUZvbGRlcigpO1xyXG5cdFx0XHRpZighZnMuZXhpc3RzU3luYyh0aGlzLmZvbGRlcikpXHJcblx0XHRcdFx0ZnMubWtkaXJTeW5jKHRoaXMuZm9sZGVyLCB7cmVjdXJzaXZlOnRydWV9KVxyXG5cdFx0XHR0aGlzLndhbGxldEZpbGUgPSB0aGlzLmNyZWF0ZUZpbGVQYXRoKCdrcGsnKTtcclxuXHRcdFx0dGhpcy50eEZpbGUgPSB0aGlzLmNyZWF0ZUZpbGVQYXRoKCdrdHgnKTtcclxuXHRcdFx0dGhpcy5jYWNoZUZpbGUgPSB0aGlzLmNyZWF0ZUZpbGVQYXRoKCdjYWNoZScpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGNyZWF0ZUZpbGVQYXRoKGV4dD0na3BrJywgc3VmZml4PScnKXtcclxuXHRcdFx0cmV0dXJuIHBhdGguam9pbih0aGlzLmZvbGRlciwgYCR7dGhpcy5maWxlTmFtZX0ke3N1ZmZpeH0uJHtleHR9YCk7XHJcblx0XHR9XHJcblxyXG5cdFx0Z2V0SG9tZUZvbGRlcigpe1xyXG5cdFx0XHRsZXQge0FQUERBVEEsIEhPTUV9ID0gcHJvY2Vzcy5lbnY7XHJcblx0XHRcdGlmKCFIT01FKVxyXG5cdFx0XHRcdEhPTUUgPSBvcy5ob21lZGlyKCk7XHJcblxyXG5cdFx0XHRpZihBUFBEQVRBKSAvLyB3aW5kb3dzXHJcblx0XHRcdFx0cmV0dXJuIHBhdGguam9pbihBUFBEQVRBLCAnS2FzcGEnKTtcclxuXHJcblx0XHRcdGlmKHByb2Nlc3MucGxhdGZvcm0gPT0gJ2RhcndpbicpXHJcblx0XHRcdFx0cmV0dXJuIHBhdGguam9pbihIT01FLCcvTGlicmFyeS9BcHBsaWNhdGlvbiBTdXBwb3J0L0thc3BhLycpO1xyXG5cclxuXHRcdFx0cmV0dXJuIHBhdGguam9pbihIT01FLCAnLmthc3BhJyk7XHJcblx0XHR9XHJcblxyXG5cdFx0YmFja3VwKCl7XHJcblx0XHRcdGxldCBiayA9ICctYmFja3VwLScrVUlEKFwiLVwiKTtcclxuXHJcblx0XHRcdGlmKGZzLmV4aXN0c1N5bmModGhpcy53YWxsZXRGaWxlKSl7XHJcblx0XHRcdFx0bGV0IG5ld1BhdGggPSB0aGlzLmNyZWF0ZUZpbGVQYXRoKCdrcGsnLCBiaylcclxuXHRcdFx0XHRmcy5yZW5hbWVTeW5jKHRoaXMud2FsbGV0RmlsZSwgbmV3UGF0aCk7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYoZnMuZXhpc3RzU3luYyh0aGlzLnR4RmlsZSkpe1xyXG5cdFx0XHRcdGxldCBuZXdQYXRoID0gdGhpcy5jcmVhdGVGaWxlUGF0aCgna3R4JywgYmspXHJcblx0XHRcdFx0ZnMucmVuYW1lU3luYyh0aGlzLnR4RmlsZSwgbmV3UGF0aCk7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYoZnMuZXhpc3RzU3luYyh0aGlzLmNhY2hlRmlsZSkpe1xyXG5cdFx0XHRcdGxldCBuZXdQYXRoID0gdGhpcy5jcmVhdGVGaWxlUGF0aCgnY2FjaGUnLCBiaylcclxuXHRcdFx0XHRmcy5yZW5hbWVTeW5jKHRoaXMuY2FjaGVGaWxlLCBuZXdQYXRoKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cclxuXHRcdHNhdmVXYWxsZXQoZGF0YTpzdHJpbmcpOnZvaWR7XHJcblx0XHRcdGZzLndyaXRlRmlsZVN5bmModGhpcy53YWxsZXRGaWxlLCBkYXRhKTtcclxuXHRcdH1cclxuXHJcblx0XHRnZXRXYWxsZXQoKTpzdHJpbmd8ZmFsc2V7XHJcblx0XHRcdGlmKGZzLmV4aXN0c1N5bmModGhpcy53YWxsZXRGaWxlKSlcclxuXHRcdFx0XHRyZXR1cm4gZnMucmVhZEZpbGVTeW5jKHRoaXMud2FsbGV0RmlsZSkrXCJcIjtcclxuXHRcdFx0cmV0dXJuIGZhbHNlO1xyXG5cdFx0fVxyXG5cclxuXHRcdHNhdmVDYWNoZShjYWNoZTpzdHJpbmcpe1xyXG5cdFx0XHRyZXR1cm4gZnMud3JpdGVGaWxlU3luYyh0aGlzLmNhY2hlRmlsZSwgY2FjaGUpO1xyXG5cdFx0fVxyXG5cdFxyXG5cdFx0Z2V0Q2FjaGUoKTpzdHJpbmd8dW5kZWZpbmVke1xyXG5cdFx0XHRpZihmcy5leGlzdHNTeW5jKHRoaXMuY2FjaGVGaWxlKSlcclxuXHRcdFx0XHRyZXR1cm4gZnMucmVhZEZpbGVTeW5jKHRoaXMuY2FjaGVGaWxlKStcIlwiO1xyXG5cdFx0XHRyZXR1cm4gdW5kZWZpbmVkO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0Y2xhc3Nlcy5GaWxlREIgPSBGaWxlREI7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBTdG9yYWdle1xyXG5cclxuXHRsb2dnZXI6YW55O1xyXG5cdGRiOkRCSW50ZXJmYWNlO1xyXG5cdGNvbnN0cnVjdG9yKG9wdDpTdG9yYWdlT3B0cz17fSl7XHJcblx0XHR0aGlzLmxvZ2dlciA9IENyZWF0ZUxvZ2dlcihcIkthc3BhU3RvcmFnZVwiKTtcclxuXHRcdGNvbnN0IHtmaWxlRGJPcHRpb25zPXt9fSA9IG9wdDtcclxuXHJcblx0XHRpZihvcHQubG9nTGV2ZWwpXHJcblx0XHRcdHRoaXMuc2V0TG9nTGV2ZWwob3B0LmxvZ0xldmVsKVxyXG5cclxuXHRcdGlmKElTX05PREUpe1xyXG5cdFx0XHR0aGlzLmRiID0gbmV3IGNsYXNzZXMuRmlsZURCKGZpbGVEYk9wdGlvbnMpO1xyXG5cdFx0fWVsc2V7XHJcblx0XHRcdHRoaXMuZGIgPSBuZXcgY2xhc3Nlcy5MU0RCKCk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHQvKlxyXG5cdCogQHJldHVybiB7U3RyaW5nfEJ1ZmZlcn0gd2FsbGV0XHJcblx0Ki9cclxuXHRnZXRXYWxsZXQoKTpXYWxsZXRDb250ZW50fGZhbHNle1xyXG5cdFx0bGV0IGNvbnRlbnQgPSB0aGlzLmRiLmdldFdhbGxldCgpO1xyXG5cdFx0aWYoIWNvbnRlbnQpXHJcblx0XHRcdHJldHVybiBmYWxzZTtcclxuXHRcdHRyeXtcclxuXHRcdFx0cmV0dXJuIEpTT04ucGFyc2UoY29udGVudCk7XHJcblx0XHR9Y2F0Y2goZSl7XHJcblx0XHRcdHJldHVybiBmYWxzZTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdF9idWlsZFdhbGxldENvbnRlbnQobW5lbW9uaWM6c3RyaW5nLCBtZXRhOldhbGxldE1ldGE9e30pe1xyXG5cdFx0cmV0dXJuIE9iamVjdC5hc3NpZ24oe1xyXG5cdFx0XHR0eXBlOiBcImthc3BhLXdhbGxldFwiLFxyXG5cdFx0XHRlbmNyeXB0aW9uOiBcImRlZmF1bHRcIixcclxuXHRcdFx0dmVyc2lvbjogMSxcclxuXHRcdFx0Z2VuZXJhdG9yOiBcImNsaVwiLFxyXG5cdFx0XHR3YWxsZXQ6IHtcclxuXHRcdFx0XHRtbmVtb25pY1xyXG5cdFx0XHR9XHJcblx0XHR9LCBtZXRhfHx7fSlcclxuXHR9XHJcblxyXG5cdGNyZWF0ZVdhbGxldChtbmVtb25pYzpzdHJpbmcsIG1ldGE6V2FsbGV0TWV0YT17fSl7XHJcblx0XHQvL3RoaXMubG9nZ2VyLmRlYnVnKFwiY3JlYXRlV2FsbGV0OlwiLCB3YWxsZXQpXHJcblx0XHR0aGlzLmRiLmJhY2t1cCgpO1xyXG5cdFx0dGhpcy5kYi5zYXZlQ2FjaGUoJycpXHJcblx0XHRyZXR1cm4gdGhpcy5zYXZlV2FsbGV0KG1uZW1vbmljLCBtZXRhKTtcclxuXHR9XHJcblx0c2F2ZVdhbGxldChtbmVtb25pYzpzdHJpbmcsIG1ldGE6V2FsbGV0TWV0YT17fSl7XHJcblx0XHQvL3RoaXMubG9nZ2VyLmRlYnVnKFwic2F2ZVdhbGxldDpcIiwgd2FsbGV0KVxyXG5cdFx0bGV0IHdhbGxldCA9IHRoaXMuX2J1aWxkV2FsbGV0Q29udGVudChtbmVtb25pYywgbWV0YSk7XHJcblx0XHRsZXQganNvbiA9IEpTT04uc3RyaW5naWZ5KHdhbGxldClcclxuXHRcdHJldHVybiB0aGlzLmRiLnNhdmVXYWxsZXQoanNvbik7XHJcblx0fVxyXG5cclxuXHQvKlxyXG5cdCogQHJldHVybiB7V2FsbGV0Q2FjaGV8dW5kZWZpbmVkfSBjYWNoZVxyXG5cdCovXHJcblx0Z2V0Q2FjaGUoKTpXYWxsZXRDYWNoZXxmYWxzZXtcclxuXHRcdGxldCBjYWNoZSA9IHRoaXMuZGIuZ2V0Q2FjaGUoKTtcclxuXHRcdGlmKCFjYWNoZSlcclxuXHRcdFx0cmV0dXJuIGZhbHNlO1xyXG5cdFx0XHJcblx0XHR0cnl7XHJcblx0XHRcdHJldHVybiBKU09OLnBhcnNlKGNhY2hlKTtcclxuXHRcdH1jYXRjaChlKXtcclxuXHRcdFx0cmV0dXJuIGZhbHNlO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0c2F2ZUNhY2hlKGNhY2hlOldhbGxldENhY2hlKXtcclxuXHRcdGxldCBkYXRhID0gSlNPTi5zdHJpbmdpZnkoY2FjaGUpO1xyXG5cdFx0dGhpcy5kYi5zYXZlQ2FjaGUoZGF0YSk7XHJcblx0fVxyXG5cclxuXHRzZXRMb2dMZXZlbChsZXZlbDpzdHJpbmcpe1xyXG5cdFx0dGhpcy5sb2dnZXIuc2V0TGV2ZWwobGV2ZWwpXHJcblx0fVxyXG5cclxuXHRhZGRUcmFuc2FjdGlvbih0eDpUWFN0b3JlSXRlbSl7XHJcblxyXG5cdH1cclxufVxyXG5cclxuXHJcbiJdfQ==